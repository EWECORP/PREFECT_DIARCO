name: dmz_diarco_flows
prefect-version: 3.4.0

pull:
- prefect.deployments.steps.set_working_directory:
    directory: E:/ETL/ETL_DIARCO

deployments:
  - name: OC_PUBLISH_PRECARGA_PROD
    entrypoint: scripts/pull/flujo_pull_PRECARGA_OC.py:precargar_OC_connexa
    description: "Publica las OC en estado 90 desde PostgreSQL hacia SQL Server"
    tags: ["pull", "oc", "precarga"]
    work_pool:
      name: dmz-diarco
      work_queue_name: pull-connexa
    schedule:
      cron: "*/10 8-17 * * 1-5"
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: REPL_SYNC_CDC_LOTES_PROD
    entrypoint: scripts/repl/flujo_replicar_DMZ_en_LOTES.py:sync_dmz_optimizado
    description: "Obtiene actualizaciones de los datos LEGACY en la DMZ (CDC)"
    tags: ["repl", "dmz", "datos"]
    work_pool:
      name: dmz-diarco
      work_queue_name: replicas-dmz
    schedule:
      cron:  "0 6 * * *"  # Todos los días a las 6 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: REPL_SYNC_OC_CDC_PROD
    entrypoint: scripts/repl/flujo_replicar_OC_en_dmz.py:flujo_replicacion_oc
    description: "Actualizar dasot de las OC en la DMZ (CDC)"
    tags: ["repl", "dmz", "datos"]
    work_pool:
      name: dmz-diarco
      work_queue_name: replicas-dmz
    schedule:
      cron:  "0 6 * * *"  # Todos los días a las 6 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: FORECAST_PUSH_INPUT_PROVEEDORES_DIARIO_PROD
    entrypoint: scripts/push/flujo_push_datos_forecast.py:forecast_flow
    description: "Carga Diaria de Datos de proveedores habilitados"
    tags: ["push", "forecast", "datos"]
    work_pool:
      name: dmz-diarco
      work_queue_name: push-forecast
    schedule:
      cron:  "30 6 * * 1-5"   # Todos los días hábiles a las 6:30 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: FORECAST_REFRESH_INPUT_PROVEEDORES_MEDIODIA_PROD
    entrypoint: scripts/push/flujo_refresh_datos_forecast.py:forecast_flow
    description: "Actualización de Datos al mediodia de proveedores habilitados"
    tags: ["push", "forecast", "datos"]
    work_pool:
      name: dmz-diarco
      work_queue_name: push-forecast
    schedule:
      cron:  "05 13 * * 1-5"   # Todos los días hábiles a las 13:05 PM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: FORECAST_PUSH_VENTAS_STOCK_DIARIO_PROD
    entrypoint: scripts/send/actualizar_bases_ventas.py:actualizar_bases_ventas
    description: "Carga Diaria de Datos de Ventas y Stock"
    tags: ["send", "forecast", "datos"]
    work_pool:
      name: dmz-diarco
      work_queue_name: push-forecast
    schedule:
      cron:  "0 7 * * *"   # Todos los días a las 7:00 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}

  - name: exportar_tabla_sql_sftp
    entrypoint: scripts/send/exportar_tabla_sqlserver_sftp.py:exportar_tabla_sql_sftp
    description: "Flujo para exportar una tabla desde SQL Server, comprimirla y transferirla vía SFTP"
    tags: ["replicacion", "sqlserver", "sftp", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: default
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  - name: REPL_ORCH_DMZ_TO_POSTGRES_PROD
    entrypoint: scripts/send/flujo_maestro_replica_datos.py:flujo_maestro
    description: "Flujo maestro orquestador para exportar, transferir e importar tablas entre SQL Server y PostgreSQL"
    tags: ["orquestador", "replicacion", "pipeline", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: default
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  - name: MASTER_SYNC_MAESTROS_POSTGRES_PROD
    entrypoint: scripts/send/actualizar_tablas_maestras.py:actualizar_tablas_maestras
    description: "Flujo maestro orquestador para subir tablas maestras entre SQL Server y PostgreSQL"
    tags: ["orquestador", "replicacion", "pipeline", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: default
    schedule:
      cron:  "30 6 * * *"   # Todos los días  a las 6:30 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  - name: MASTER_SYNC_TABULARES_POSTGRES_PROD
    entrypoint: scripts/send/actualizar_tablas_tabulares.py:actualizar_tablas_tabulares
    description: "Flujo maestro orquestador para subir tablas Tabulares entre SQL Server y PostgreSQL"
    tags: ["orquestador", "replicacion", "pipeline", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: default
    schedule:
      cron:  "50 6 * * *"   # Todos los días a las 6:30 AM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  - name: ETL_REFRESH_BVE_DIARIO_PROD
    entrypoint: scripts/push/actualizar_base_ventas_extendida.py:actualizar_base_ventas_extendida
    description: "Carga incremental con ventana y upsert"
    tags: ["bve","etl","diario"]
    version: "1.0.1"
    parameters:
      window_days: 14
      analyze: true
    schedule:
      cron: "15 6 * * *"   # todos los días 06:15 América/Buenos_Aires
      timezone: "America/Argentina/Buenos_Aires"

  - name: ETL_REFRESH_BVE_BARRIO_DIARIO_PROD
    entrypoint: scripts/push/actualizar_base_ventas_extendida_barrio.py:actualizar_base_ventas_extendida_barrio
    description: "Carga incremental con ventana y upsert"
    tags: ["bve","etl","diario"]
    version: "1.0.1"
    parameters:
      window_days: 14
      analyze: true
    schedule:
      cron: "45 6 * * *"   # todos los días 06:15 América/Buenos_Aires
      timezone: "America/Argentina/Buenos_Aires"

  - name: MASTER_SYNC_MAESTROS_POSTGRES_PROD
    entrypoint: scripts/send/refresh_tablas_maestras.py:main_flow
    description: "Flujo maestro orquestador para REFreSCAR tablas entre SQL Server y PostgreSQL"
    tags: ["orquestador", "replicacion", "pipeline", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: default
    schedule:
      cron:  "05 13 * * *"   # Todos los días a las 13:05 PM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  - name: TRANSFER_PUBLISH_VKM_PROD
    entrypoint: scripts/pull/flujo_publicar_transferencias_sgm_vk.py:publicar_transferencias_sgm_vk
    description: "Flujo Publicar y Actualizar estado Transferencias SGM_VKM"
    tags: ["Transferencias", "replicacion", "pipeline", "etl"]
    work_pool:
      name: dmz-diarco
      work_queue_name: pull-connexa
    schedule:
      cron:  "08 10 * * *"   # Todos los días a las 13:05 PM  
      timezone: "America/Argentina/Buenos_Aires"
    parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

  # ==========================================================
  # TEST
  # ==========================================================
  - name: PAS_PUSH_OC_RECEPCION_TEST
    description: "Sincronización de Órdenes de Compra (Recepción) hacia CONNEXA TEST.
      Origen: diarco_data (DMZ)
      Destino: PostgreSQL TEST (PGT_*)"
    entrypoint: scripts/pull/sincronizar_oc_recepcion.py:sync_flow
    parameters:
      dest_env: TEST
    work_pool:
      name: dmz-diarco
    work_queue_name: recepcion
    tags: ["oc", "recepcion", "diarco", "test"]
    schedules:
      - cron: "0 */2 * * *"
        timezone: America/Argentina/Buenos_Aires
        active: false

  # ==========================================================
  # DESA
  # ==========================================================
  - name: PAS_PUSH_OC_RECEPCION_DESA
    description: "Sincronización de Órdenes de Compra (Recepción) hacia CONNEXA DESARROLLO.
      Origen: diarco_data (DMZ)
      Destino: PostgreSQL DESA (PGD_*)"
    entrypoint: scripts/pull/sincronizar_oc_recepcion.py:sync_flow
    parameters:
      dest_env: DESA
    work_pool:
      name: dmz-diarco
    work_queue_name: recepcion
    tags: ["oc", "recepcion", "diarco", "desa"]
    schedules:
      - cron: "0 * * * *"
        timezone: America/Argentina/Buenos_Aires
        active: false

  # ==========================================================
  # PROD
  # ==========================================================
  - name: PAS_PUSH_OC_RECEPCION_PROD
    description: "Sincronización de Órdenes de Compra (Recepción) hacia CONNEXA PRODUCCIÓN.
      Origen: diarco_data (DMZ)
      Destino: PostgreSQL PROD (PGP_*)"
    entrypoint: scripts/pull/sincronizar_oc_recepcion.py:sync_flow
    parameters:
      dest_env: PROD
    work_pool:
      name: dmz-diarco
    work_queue_name: recepcion
    tags: ["oc", "recepcion", "diarco", "prod"]
    schedules:
      - cron: "*/15 * * * *"
        timezone: America/Argentina/Buenos_Aires
        active: false


  # - name: Actualizar_Bases_Ventas_Postgres
  #   entrypoint: scripts/send/actualizar_bases_ventas.py:actualizar_bases_ventas
  #   description: "Flujo maestro orquestador para subir tablas Ventas DIARDO + BARRIO entre SQL Server y PostgreSQL"
  #   tags: ["orquestador", "replicacion", "pipeline", "etl"]
  #   work_pool:
  #     name: dmz-diarco
  #     work_queue_name: default
  #   schedule:
  #     cron:  "01 6 * * *"   # Todos los días a las 6:01 AM  
  #     timezone: "America/Argentina/Buenos_Aires"
  #   parameters: {}  # Parámetros definidos al momento de ejecutar el flujo

#  prefect deploy scripts/send/actualizar_bases_ventas.py:actualizar_bases_ventas  --name Push_datos_Ventas_Stock_Diarios  --work-queue push-forecast  --cron "30 6 * * *"
